<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Таймер</title>
	<link rel="stylesheet" href="css/timerwood.css">
	<!-- <script src="http://mr-woodman.ru/js/typogrid.js"></script> -->
	
	<script src="js/funnyphrases.js"></script>
</head>
<body>

<page ng-app="TimerwoodApp">

	<div ng-controller="HelpCtrl" ng-cloak>
		<a class="open-help" ng-click="toggleHelp()" title="Открыть помощь">?</a>

		<div id="help" ng-show="help">
			<!--  -->
		</div>
	</div>

	<div ng-controller="TimerCtrl" ng-class="[status, type]" ng-cloak>
		<button class="time" ng-click="toggle()" title="{{toggleTip[status]}}">
			<span class="hour" ng-class="{low: info.duration < 3600000}">{{info.duration|filterMillisecondsTo:"hh"}}</span><span class="divider" ng-class="{low: info.duration < 60000}">:</span><span class="min" ng-class="{low: info.duration < 60000}">{{info.duration|filterMillisecondsTo:"mm":true}}</span>
			<span class="sec">{{info.duration|filterMillisecondsTo:"ss":true}}</span>
			<span class="ms">{{info.duration|filterMillisecondsTo:"ms":true}}</span>
		</button>

		<input type="text" class="task"
			ng-show="type != 'simple'" 
			ng-model="details" 
			ng-list=","
			ng-keydown="save($event);"
			placeholder="{{funnytask}}"
			tw-focus-on-edit>

		<help class="button-help" ng-show="help" ng-cloak>
			<img src="images/help-arrow-01.png">
			<strong>Главная Кнопка таймера,</strong><br>
			запускать также можно:<br>
			&mdash; кликами по задачам в видах задачи/дни/хранилище,<br>
			&mdash; и Enter’ом в поле справа.
		</help>
		<help class="input-help" ng-show="help" ng-cloak>
			<img src="images/help-arrow-02.png">
			Ввод названия задачи (генерится случайно, если не вводить).<br>
			<strong>Через запятую</strong> задаётся вложенность задачи, <strong>enter</strong>’ом запускается таймер.  
		</help>
	</div>

	<div>&nbsp;</div>
	<div>&nbsp;</div>
	<div>&nbsp;</div>
	<div>&nbsp;</div>

	<div class="switch-views" ng-controller="SwitchViewCtrl" ng-show="storage.length > 0" ng-cloak ng-init="samples=false">
		<nav>
			<help class="views-help" ng-show="help" ng-cloak>
				<img src="images/help-arrow-03.png">
				Записи внутренне хранятся простым списком (<strong>хранилище</strong>). <br>
				Для удобства они группируются в виде истории (<strong>дни</strong>) или <br>
				дерева подзадач (<strong>задачи</strong>).
			</help>

			<a ng-click="currentView = 'task'" title="">задачи</a>
			<a ng-click="currentView = 'date'" title="">дни</a>
			<!-- <a ng-click="currentView = 'log'" title="">лог</a> -->
			<a ng-click="currentView = 'storage'" title="Формат хранения задач на сервере, недавние вверху. Для низкоуровневого редактирования и дебага">хранилище</a>
		</nav>


		<!-- Попапы -->
		<div class="dialog" ng-show="samples" ng-cloak>
			<article style="width: 550px;">
				<h3>Примеры ст</h3>
				<p>Это крупное изменение.</p>

				<p style="text-align: center;">
					<a class="ok" ng-click="samples=false">Ладно</a>
				</p>
			</article>
		</div>



		<!-- Задачи -->
		<div class="view" ng-controller="TasksViewCtrl" ng-class="{show: currentView == 'task'}" ng-init="recentTasks = false">
			<section class="recent">
				<ul class="task-list">
					<li ng-repeat="task in tasks | filter:recent" ng-include="'task-template'" ng-class="{group: task.children.length > 0}"></li>
				</ul>
			</section>

			<div class="toggle-all" ng-show="tasks.length > recentCount">
				<a ng-click="recentTasks = !recentTasks">
					{{ recentTasks && "Скрыть" || "Показать" }} ранние проекты
				</a>
			</div>

			<section class="all" ng-show="recentTasks == true">
				<ul class="task-list">
					<li ng-repeat="task in tasks | filter:excludeRecent" ng-include="'task-template'" ng-class="{group: task.children.length > 0}"></li>
				</ul>
			</section>
		</div>

		<!-- По дням -->
		<div class="view" ng-controller="DateViewCtrl" ng-class="{show: currentView == 'date'}" ng-init="recentDates = false">
			<section class="recent">
				<ul class="date-list">
					<li 
						ng-repeat="entry in days | filter:recent" 
						ng-include="'day-template'"></li>
				</ul>
			</section>

			<div class="toggle-all" ng-show="days.length > recentCount">
				<a ng-click="recentDates = !recentDates">
					{{ recentDates && "Скрыть" || "Показать" }} ранние даты
				</a>
			</div>

			<section class="all" ng-show="recentDates == true">
				<ul class="date-list">
					<li 
						ng-repeat="entry in days | filter:excludeRecent" 
						ng-include="'day-template'"></li>
				</ul>
			</section>
		</div>

		<!-- Хранилище -->
		<div class="view" ng-controller="StorageViewCtrl" ng-class="{show: currentView == 'storage'}">
			<!-- Поиск -->
			<form class="search-entries">
				<input type="text" class="small"
					ng-model="search" 
					ng-list=","
					tw-focus-on-switch-view 
					placeholder="Введите фильтры через запятую">
			</form>

			<!-- Список -->
			<ul class="storage-list">
				<li ng-repeat="entry in filtered = (entries | filter:searchTags)" ng-init="status='view'" ng-class="status">
					<span class="start"
						ng-show="status=='view'">{{entry.start | filterDateTo:'dd.mm.yyyy'}}</span>

					<input type="text" class="small date" 
						ng-model="entry.editDate" 
						ng-show="status=='edit'"
						ng-keydown="checkSubmit($event, entry, this)">

					<span class="start">в</span> 
					
					<span class="start"
						ng-show="status=='view'">{{entry.start | filterDateTo: 'hh:mm'}}</span>

					<input type="text" class="small start" 
						tw-focus-on-edit 
						ng-model="entry.editStart" 
						ng-show="status=='edit'"
						ng-keydown="checkSubmit($event, entry, this)">

					<span class="details" title="Запустить задачу" 
						ng-click="start(entry.details)" 
						ng-show="status=='view'" 
						scroll-top-on-click>{{entry.details}}</span>

					<input type="text" class="small details"
						ng-model="entry.editDetails" 
						ng-list="," 
						ng-show="status=='edit'" 						
						ng-keydown="checkSubmit($event, entry, this)">

					<span class="duration"
						ng-show="status=='view'">{{entry.stop - entry.start | filterMillisecondsTo:'hour min'}}</span>

					<input type="text" class="small duration" 
						ng-model="entry.editDuration" 
						ng-show="status=='edit'"
						ng-keydown="checkSubmit($event, entry, this)">

					<span class="controls">
						<a class="delete" ng-click="delete(entry); status='view'">удалить</a>
						<a class="edit" ng-click="edit(entry); status='edit';" ng-show="status=='view'">редактировать</a>
						<a class="save" ng-click="save(entry); status='view'" ng-show="status=='edit'">сохранить</a>
						<a class="cancel" ng-click="cancel(entry); status='view'" ng-show="status=='edit'">отмена</a>
					</span>
				</li>
			</ul>

			<!-- Хелп по хранилищу -->
			<help class="storage-help" ng-show="help" ng-cloak>
				<!-- <img src="images/help-arrow-04.png"> -->

			</help>
		</div>
	</div>

	<footer ng-controller="FooterCtrl" ng-show="storage.length > 0" ng-cloak>
		<span style="font-size: 18px;">Таймер 3.0</span>
		<br><span>сделано на левом берегу &trade;</span>
		<br><br><img src="images/cat-preloader.gif">
	</footer>

	<!-- Шаблон задачи -->
	<script type="text/ng-template" id="task-template">
		<div class="task" ng-class="{group: task.children.length > 0, leaf: task.children.length == 0, view: status=='view', edit: status=='edit'}" tw-parent-hover ng-init="status='view'">
			<a class="name" title="Продолжить задачу" 
				ng-click="start(task)" 
				ng-show="status == 'view' && task.children.length < 1"
				scroll-top-on-click>{{task.name}}</a>

			<a class="name" title="Начать подзадачу" 
				ng-click="subTask(task)" 
				ng-show="status == 'view' && task.children.length > 0"
				scroll-top-on-click>{{task.name}}</a>

			<input type="text" class="small name"
				ng-model="task.path"
				ng-list="," 
				ng-show="status=='edit'" 
				tw-focus-on-edit 
				ng-keydown="checkSubmit($event, task, this)">

			<span style="opacity: 0.5; padding: 0 0.125em;" ng-show="(task.getOwnDuration() > 60000 && task.children.length > 0) || task.children.length == 0">&ndash;</span>

			<span class="duration" ng-show="(task.getOwnDuration() > 60000 && task.children.length > 0) || task.children.length == 0">{{task.getOwnDuration() | filterMillisecondsTo:'hour min'}}</span>
			
			<span class="duration-total" ng-show="task.children.length > 0">{{task.getDuration() | filterMillisecondsTo:'hour min'}}</span>

			<span class="controls" ng-class="status">
				<a class="sub-task" ng-click="subTask(task)" ng-show="status=='view'" scroll-top-on-click>подзадача</a>
				<a class="edit" ng-click="edit(task); status='edit'" ng-show="status=='view'">редактировать</a>
				<a class="filter-storage" 
					ng-click="filterStorageView(task);" 
					ng-show="status=='view'" 
					title="Поиск записей по хранилищу" 
					scroll-top-on-click><img class="icon" src="images/icon-search.svg" alt="Поиск по хранилищу"></a>
				<!--a class="delete" ng-click="delete(task); status='view'" ng-show="status=='edit'">удалить</a-->
				<a class="save" ng-click="save(task); status='view'" ng-show="status=='edit'">сохранить</a>
				<a class="cancel" ng-click="cancel(task); status='view'" ng-show="status=='edit'">отмена</a>
			</span>
		</div>


		<ul ng-show="task.children.length > 0">
			<li 
				ng-repeat="task in task.children" 
				ng-include="'task-template'" 
				ng-class="{group: task.children.length > 0}" 
				ng-init="status='view'" 
				tw-hover-leaf-li>
		</ul>
	</script>

	<!-- Шаблоны дня -->
	<script type="text/ng-template" id="day-template">
		<header>
			<span class="today">{{entry.date | filterDateTo: 'today'}}</span>
			<span class="date">{{ entry.date | filterDateTo:'d' }}</span>
			<span class="month">{{ entry.date | filterDateTo:'M' }}</span>
			<span class="duration">{{ entry.getDuration() | filterMillisecondsTo:'hour min' }}</span>

			<span class="controls">
				<a class="filter-storage" 
					ng-click="filterStorageViewByDate(entry.date);" 
					title="Поиск записей по хранилищу" 
					scroll-top-on-click><img class="icon" src="images/icon-search.svg" alt="Поиск по хранилищу"></a>
			</span>
		</header>

		<ul class="leaf-task-list">
			<li ng-repeat="task in entry.tasks" ng-init="status = 'view'" ng-class="status">
				<a class="task" title="Продолжить задачу" 
					ng-click="start(task.details)" 
					scroll-top-on-click 
					parent-hover parent-hover-class="hover-task" 
					ng-show="status=='view'">

					<span 
						ng-repeat-start="name in task.details track by $index" 
						ng-class="{group : $index < task.details.length - 1, leaf: $index == task.details.length -1}">
							{{name}}</span><span ng-repeat-end class="divider" ng-show="$index < task.details.length - 1">, 
					</span>
				</a>
				
				<input type="text" class="small details"
					ng-model="task.editDetails" 
					ng-list="," 
					ng-show="status=='edit'" 
					tw-focus-on-edit 
					ng-keydown="checkSubmit($event, task, this)">

				<span style="opacity: 0.5; padding: 0 0.125em;">&ndash;</span>
				
				<span class="duration"  ng-show="status=='view'">{{ task.getDuration() | filterMillisecondsTo:'hour min' }}</span>

				<input type="text" class="small duration" 
					value="{{task.getDuration() | filterMillisecondsTo:'h m'}}" 
					ng-model="task.editDuration" 
					ng-show="status=='edit'"
					ng-keydown="checkSubmit($event, task, this)">

				<span class="controls">
					<a class="edit" ng-click="edit(task); status='edit'" ng-show="status=='view'">редактировать</a>
					<a class="filter-storage" 
						ng-click="filterStorageView(task);" 
						ng-show="status=='view'" 
						title="Поиск записей по хранилищу" 
						scroll-top-on-click><img class="icon" src="images/icon-search.svg" alt="Поиск по хранилищу"></a>
					<a class="delete" ng-click="delete(task); status='view'" ng-show="status=='edit'">удалить</a>
					<a class="save" ng-click="save(task); status='view'" ng-show="status=='edit'">сохранить</a>
					<a class="cancel" ng-click="cancel(task); status='view'" ng-show="status=='edit'">отмена</a>
				</span>
			</li>
		</ul>
	</script>


	<!-- Попапы -->
	<div class="dialog" ng-controller="PopupCtrl" ng-show="greetingPopup" ng-cloak>
		<article style="width: 550px;">
			<h3>Таймер 3.0</h3>
			<p>Это крупное изменение.</p>
			<p>В нём я постарался реализовать все что хотел и так, как хотел. И это получилось.</p>
			<p>Среди фич, которые просили:<br>
				&emsp; &mdash; &nbsp; разбиение по задачам (вид &laquo;задачи&raquo;)<br>
				&emsp; &mdash; &nbsp; редактирование<br>
				&emsp; &mdash; &nbsp; <del>отчёты c баблом и синхронизация</del> (в след. апдейтах)
			</p>
			<p>Если не разберетесь или чего-то не хватает, пишите на <a href="http://www.facebook.com/woodmanswork" target="_blank">facebook.com/woodmanswork</a></p>
			<p style="text-align: center;">
				<a class="ok" ng-click="close('greetingPopup')">Очень рад</a>
				&emsp;
				<a class="ok" ng-click="close('greetingPopup')">Да пофиг</a>
			</p>
			<p style="text-align: center;"><label><input type="checkbox" ng-model="hideGreetingPopup" checked="checked" ng-change="save(hideGreetingPopup)"> Не показывать в след. раз</label></p>
		</article>
	</div>

</page>


<script src="lib/jquery/jquery-1.9.1.min.js"></script>
<script src="lib/angular/angular.js"></script>
<script src="js/app.js"></script>
<script src="js/ctrl-timer.js"></script>
<script src="js/ctrl-switchview.js"></script>
<script src="js/ctrl-storageview.js"></script>
<script src="js/ctrl-dateview.js"></script>
<script src="js/ctrl-taskview.js"></script>
<script src="js/filters.js"></script>
<script src="js/services.js"></script>
<script src="js/directives.js"></script>

</body>
</html>